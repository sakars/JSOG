name: Build and Test

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # Checkout the code
    - name: Checkout code
      uses: actions/checkout@v4

    # Set up CMake
    - name: Set up CMake
      uses: lukka/get-cmake@latest

    # Install dependencies
    - name: Install dependencies
      run: |
        sudo apt-get update

    - name: Install nlohmann/json
      run: |
        # Clone and install nlohmann/json
        git clone https://github.com/nlohmann/json.git
        cd json
        mkdir build && cd build
        cmake ..
        make install
        cd ../..
    
    - name: Install uriparser
      run: |
        # Clone and install uriparser
        git clone https://github.com/uriparser/uriparser
        cd uriparser
        mkdir build && cd build
        cmake ..
        make install
        cd ../..

    # Configure the project
    - name: Configure with CMake
      run: |
        cmake -Bbuild -H. -Dnlohmann_json_DIR=../json/build -Duriparser_DIR=../uriparser/build
          

    # Build the project
    - name: Build the project
      run: cmake --build build --target all -- -j$(nproc)

    # Upload build artifacts
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: build

  test:
    runs-on: ubuntu-latest
    needs: build

    steps:
    # Checkout the code (necessary to keep the source files synced)
    - name: Checkout code
      uses: actions/checkout@v3

    # Download build artifacts
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: build-artifacts

    # Run tests
    - name: Run tests
      run: ctest --test-dir build --output-on-failure
